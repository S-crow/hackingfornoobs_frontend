{"ast":null,"code":"import _classCallCheck from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/inherits\";import React from'react';import Cerbere from\"../img/kerberos.png\";import KerberosImg from\"../img/kerberos.jpg\";var Kerberos=/*#__PURE__*/function(_React$Component){_inherits(Kerberos,_React$Component);function Kerberos(){_classCallCheck(this,Kerberos);return _possibleConstructorReturn(this,_getPrototypeOf(Kerberos).apply(this,arguments));}_createClass(Kerberos,[{key:\"render\",value:function render(){return React.createElement(\"div\",{className:\"article\"},React.createElement(\"h1\",null,\"Kerberos\"),React.createElement(\"hr\",null),React.createElement(\"p\",{className:\"tabulation\"},\"En mythologie, Kerberos (plus connu sous le nom de Cerb\\xE8re) est un \\xE9norme chien \\xE0 trois t\\xEAtes qui garde l\\u2019entr\\xE9e des Enfers. Dans le domaine informatique il s'agit du protocole d'authentification dans un r\\xE9seau informatique qui a besoin de 3 entit\\xE9s distincte pour fonctionner, d'o\\xF9 la r\\xE9f\\xE9rence pour le nom.\"),React.createElement(\"img\",{id:\"cerbere_img\",src:Cerbere,alt:\"sch\\xE9ma Kerberos\"}),React.createElement(\"h2\",null,\"Qu'est-ce que Kerberos ?\"),React.createElement(\"p\",{className:\"tabulation\"},\"Protocole d'authentification des utilisateurs dans un r\\xE9seau d\\xE9velopp\\xE9 par le MIT, fonctionnant de pair avec un Active Directory, il permet l'acc\\xE8s des utilisateurs \\xE0 des services de mani\\xE8re authentifi\\xE9e.\"),React.createElement(\"p\",null,\"Le principe de Kerberos est de centraliser la gestion de l'authentification, de sorte que les identifiants n'aient pas besoin de circuler sur le r\\xE9seau et les serveurs d'en avoir connaissance. Toute l'authentification est g\\xE9r\\xE9e par le \",React.createElement(\"strong\",null,\"KDC (Key Distribution Center)\"),\" suivant 3 \\xE9tapes :\"),React.createElement(\"ol\",null,React.createElement(\"li\",null,React.createElement(\"strong\",null,\"Authentification\"),\" du client aupr\\xE8s du KDC Authentication Service (AS)\"),React.createElement(\"li\",null,\"Demande du client d'un \",React.createElement(\"strong\",null,\"Ticket de Service\"),\" (TGS)\"),React.createElement(\"li\",null,React.createElement(\"strong\",null,\"Acc\\xE8s au service\"),\" en lui fournissant le ticket associ\\xE9\")),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Principe de fonctionnement\"),React.createElement(\"img\",{id:\"principe_kerberos\",src:KerberosImg,alt:\"sch\\xE9ma Kerberos\"}),React.createElement(\"ol\",null,React.createElement(\"li\",null,\"1.Le client demande \\xE0 s'authentifier aupr\\xE8s du Serveur d'Authentification (AS) en demandant un TGT\"),React.createElement(\"li\",null,\"2.Le KDC v\\xE9rifie les donn\\xE9es d\\u2019identification et renvoie en cas de succ\\xE8s au client un TGT\"),React.createElement(\"li\",null,\"3. Le client envoie son TGT au TGS avec le Service Principal Name (SPN) de la ressource \\xE0 laquelle il souhaite acc\\xE9der\"),React.createElement(\"li\",null,\"4.Le KDC v\\xE9rifie le TGT et s\\u2019assure que l\\u2019utilisateur a droit d'acc\\xE8der au service demand\\xE9\"),React.createElement(\"li\",null,\"5.S'il y est autoris\\xE9, le TGS va alors fournir un ticket de service au client\"),React.createElement(\"li\",null,\"6.Le client pr\\xE9sente son ticket au service concern\\xE9, qui lui accordera l'acc\\xE8s au ressource selon ses privil\\xE8ges\")),React.createElement(\"p\",null,\"Dans un environnement Active Directory, les contr\\xF4leurs de domaine (Domain controllers ou DC) jouent le r\\xF4le de KDC et assurent donc les services d'Authentication Server (AS) et de Ticket Granting Service (TGS)\"),React.createElement(\"p\",null,\"[Comparaison foireuse] En gros on pourrait comparer le principe de ticketing de Kerberos \\xE0 celui de certains parcs d'attraction : il faut d'abord un ticket d'entr\\xE9e g\\xE9n\\xE9ral pour acc\\xE8der au parc (TGT) avant de faire la demande de tickets sp\\xE9cifiques pour acc\\xE8der \\xE0 chacune des attractions (TGS). A la diff\\xE9rence que dans Kerberos il n'y a ni coupe-file ni fast-pass ;)\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Quelle diff\\xE9rence entre Kerberos et NTLM ?\"),\"[D\\xE9finir NTLM]\",React.createElement(\"p\",{className:\"tabulation\"},\"La principale diff\\xE9rence entre les deux syst\\xE8mes est la v\\xE9rification tierce partie et le chiffrement plus efficace de Kerberos. Cette \\xE9tape suppl\\xE9mentaire du processus apporte une couche suppl\\xE9mentaire de s\\xE9curit\\xE9 importante par rapport \\xE0 NTLM. Actuellement, la technologie NTLM est obsol\\xE8te et n'assure plus correctement la protection des donn\\xE9es sensibles.\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Les attaques sur Kerberos\"),React.createElement(\"p\",null,\"Kerberos \\xE9tant la solution la plus d\\xE9ploy\\xE9e pour tout ce qui concerne l'authentification dans un r\\xE9seau d'entreprise il est \\xE9videmment cibles de nombreuses attaques qui peuvent en cas de r\\xE9ussite mener jusqu'\\xE0 la compromission totale du SI. \"),React.createElement(\"ul\",null,React.createElement(\"li\",null,React.createElement(\"a\",{href:\"#spn\"},\"Scan des SPN\")),React.createElement(\"li\",null,\"Pass-the-ticket : falsification d'une cl\\xE9 de session pour la pr\\xE9senter \\xE0 une ressource sous la forme de donn\\xE9es d\\u2019identification\"),React.createElement(\"li\",null,React.createElement(\"a\",{href:\"#kerberoasting\"},\"Kerberoasting\")),React.createElement(\"li\",null,React.createElement(\"a\",{href:\"#asreproasting\"},\"AS-REPRoasting\")),React.createElement(\"li\",null,React.createElement(\"a\",{href:\"#golden\"},\"Golden Ticket\"),\" : falsification d'un ticket accordant \\xE0 un utilisateur un acc\\xE8s administrateur du domaine\"),React.createElement(\"li\",null,React.createElement(\"a\",{href:\"#silver\"},\"Silver Ticket\"),\" : falsification d'un ticket donnant acc\\xE8s \\xE0 un service\"),React.createElement(\"li\",null,\"Credential stuffing (bruteforce) : tentatives r\\xE9p\\xE9t\\xE9es automatis\\xE9es visant \\xE0 cracker un mot de passe\"),React.createElement(\"li\",null,\"Affaiblissement du chiffrement via un Skeleton Key : malware capable de passer outre Kerberos (n\\xE9cessitant un acc\\xE8s admin)\"),React.createElement(\"li\",null,\"Attaque DCShadow : nouvelle attaque consistant \\xE0 d\\xE9finir son propre contr\\xF4leur de domaine afin de s\\u2019infiltrer plus en profondeur\")),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"spn\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Scan des Service Principal Name (SPN)\"),React.createElement(\"p\",{className:\"tabulation\"},\"Afin de gagner en furtivit\\xE9 dans un r\\xE9seau en environnement AD, le traditionnel scan de ports est \\xE0 remplacer par un scan SPN. Il s'agit des cha\\xEEnes de caract\\xE8res associ\\xE9es \\xE0 un service qui sont r\\xE9pertori\\xE9es pour chaque compte dans l'annuaire LDAP. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\" En faisant une requ\\xEAte LDAP sur le DC on peut donc \\xE9num\\xE9rer l'ensemble des services. L'avantage \\xE9tant qu'il n'y a pas besoin d'initier une connexion sur chacun des serveurs h\\xE9bergeant un service. Cette m\\xE9thode, plus discr\\xE8te, peut \\xEAtre r\\xE9aliser sur n'importe quel poste connect\\xE9 \\xE0 l'AD via la commande : \",React.createElement(\"strong\",null,\"setspn.exe\")),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"kerberoasting\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Kerberoasting\"),React.createElement(\"p\",{className:\"tabulation\"},\"C'est une attaque qui cible les comptes de services qui sont r\\xE9pertori\\xE9s au niveau de l'annuaire LDAP (SPN). \",React.createElement(\"br\",null),\" Le Kerberoasting consiste \\xE0 demander au TGS des tickets de services pour chacun des SPN \\xE9num\\xE9r\\xE9s (r\\xE9cup\\xE9r\\xE9s auparavant via Setspn.exe par exemple), cela n\\xE9cessite \\xE9videmment d'avoir un TGT donc au moins un compte user simple. \",React.createElement(\"br\",null),\" Comme chaque ticket de service est chiffr\\xE9 avec une cl\\xE9 correspondant au hash du mot de passe il est ensuite possible de lancer une attaque par bruteforce pour casser le mot de passe du compte cibl\\xE9.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Le script GetUsersSPNs.py d'Impacket permet d'obtenir les hash des mots de passe des comptes de services \\xE0 distance en fournissant l'adresse IP du DC et des creds d'un compte user simple.\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"asreproasting\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"AS-REPRoasting\"),React.createElement(\"p\",{className:\"tabulation\"},\"Il existe une pr\\xE9-authentification sur Kerberos qui consiste \\xE0 ajouter \\xE0 la 1ere requete la valeur de l'horodataga chiffr\\xE9e avec la cl\\xE9 du compte utilisateur.\",React.createElement(\"br\",null),\"Si elle n'est pas pr\\xE9sente c\\xE0d si le flag \\\"DONT_REQ-AUTH\\\" est pr\\xE9sent dans le champ UserAccountControl d'un compte utilisateur, alors  cela signifie que ce dernier peut faire une demande de TGT sans s'\\xEAtre pr\\xE9-authentifi\\xE9. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\"L'AS-REPRoasting consiste \\xE0 \\xE9num\\xE9rer l'ensemble des comptes poss\\xE8dant ce flag, de faire une demande de TGT \\xE0 la place de ces utiisateurs pour tenter, en \\\"offline\\\", de casser leur mot de passe.\",React.createElement(\"br\",null),React.createElement(\"br\",null),React.createElement(\"strong\",null,\"GetNPUsers.py\"),\" d'Impacket permet de r\\xE9cup\\xE9rer les hash de ces comptes. [screen]\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"delegation\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Delegation d'authentification (sans contrainte)\"),React.createElement(\"p\",{className:\"tabulation\"},\"Certains serveurs qui poss\\xE8dent le flag \\\"TRUSTED_FOR_DELEGATION\\\" gardent en cache  dans le processus lsass les TGT des utilisateurs pour pouvoir effectuer \\xE0 leur place la demande d'acc\\xE8s \\xE0 un autre service. Ainsi en cas de compromission de l'un de ces serveurs on peut r\\xE9cup\\xE9rer l'ensemble des TGT stock\\xE9s. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\"L'outil \",React.createElement(\"strong\",null,\"ldapdomaindump\"),\" permet d'\\xE9num\\xE9rer ces machines. [screen]\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"On utilise ensuite Mimikatz pour r\\xE9cup\\xE9rer les tickets en m\\xE9moire. \",React.createElement(\"br\",null),\"kerberos::list /export [screen]\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"passtheticket\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Pass-The-Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Cette attaque consiste \\xE0 injecter des TGT pr\\xE9cedemment r\\xE9cup\\xE9r\\xE9s directement dans la m\\xE9moire du processus lsass d'autres machines pour augmenter ses acc\\xE8s.\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"golden\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Golden Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Dans un environnement Active Directory, les comptes sont identifi\\xE9s par un nom d\\u2019utilisateur et un mot de passe, l\\u2019utilisateur identifi\\xE9 obtient alors un ticket Kerberos contenant son jeton d\\u2019authentification.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Le Golden Ticket est le jeton d\\u2019authentification associ\\xE9 au compte KRBTG, un compte sp\\xE9cial servant \\xE0 chiffrer tous les jetons d\\u2019authentification du DC. Ce Golden Ticket peut \\xEAtre utiliser avec une technique de \",React.createElement(\"strong\",null,\"Pass-the-hash\"),\" pour se connecter \\xE0 n\\u2019importe quel compte.\"),React.createElement(\"ol\",null,React.createElement(\"li\",null,\"Infecter une machine cible avec un malware qui permet un premier acc\\xE8s avec un compte utilisateur pour acc\\xE9der \\xE0 d\\u2019autres ressources r\\xE9seau (souvent \\xE0 partir d\\u2019un e-mail de phishing)\"),React.createElement(\"li\",null,\"Augmenter suffisamment ses privil\\xE8ges pour avoir acc\\xE8s au Contr\\xF4leur de domaine (DC)\"),React.createElement(\"li\",null,\"Se connecter au DC et dumper le hash du mot de passe du compte KRBTG pour cr\\xE9er un Golden Ticket. (via mimikatz)\"),React.createElement(\"li\",null,\"Le Golden Ticket permet d'acc\\xE9der \\xE0 toutes les ressources pr\\xE9sentes sur le r\\xE9seau\")),React.createElement(\"p\",null,\"M\\xEAme une modification du mot de passe du compte KRBTG n'entra\\xEEne pas l'invalidation du jeton d\\u2019authentification, donc le Golden Ticket est immuable.\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"silver\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Silver Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Avec le mot de passe d\\u2019un compte il est possible de l\\u2019utiliser pour cr\\xE9er un faux ticket d\\u2019authentification de service appel\\xE9 \",React.createElement(\"strong\",null,\"Silver Ticker\"),\". La cr\\xE9ation de Silver Ticket est possible car Kerberos permet aux services de se connecter sans que la validit\\xE9 de leur jeton ne soit v\\xE9rifi\\xE9e.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"[Sean Metcalf] \",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Un Silver Ticket est un faux ticket d\\u2019authentification utilis\\xE9 pour se connecter \\xE0 certains comptes. Ils sont plus difficiles \\xE0 d\\xE9tecter que les Golden Tickets en raison de l\\u2019absence de communication entre le service et le DC et comme la journalisation se fait en local sur l\\u2019ordinateur cible.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Les tickets Kerberos sont v\\xE9rifi\\xE9s par le Certificat de compte habilit\\xE9 (PAC) mais les comptes de services (comme CIFS ou le pare-feu Windows) ne sont pas toujours v\\xE9rifi\\xE9s.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Avec un Silver Ticket, on peut s'authentifier aupr\\xE8s du contr\\xF4leur de domaine ou utiliser une technique Pass-the-ticket pour augmenter ses acc\\xE8s.\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Contre-mesures\"),React.createElement(\"ul\",null,React.createElement(\"li\",null,\"mots de passe robustes pour les comptes de service\"),React.createElement(\"li\",null,\"flag \\\"Not_DELEGATED\\\" sur l'attribut UserAccountControol des comptes d'utilisateurs ayant acc\\xE8s \\xE0 des ressources sensibles.\"),React.createElement(\"li\",null,\"changement du mot de passe du compte krbtgt 2 fois tous les 40 jours\"),React.createElement(\"li\",null,\"d\\xE9tection d'un nombre trop important de demandes de ticket de service (Kerberoasting)\")),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Conclusion\"),React.createElement(\"p\",{className:\"tabulation\"},\"Kerberos est un protocole d'authentification robuste et efficace qui est encore loin d\\u2019\\xEAtre obsol\\xE8te.\"));}}]);return Kerberos;}(React.Component);export default Kerberos;","map":{"version":3,"sources":["/mnt/c/Users/Nico/hackingfornoobs_frontend/src/components/Kerberos.js"],"names":["React","Cerbere","KerberosImg","Kerberos","Component"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport Cerbere from \"../img/kerberos.png\"\r\nimport KerberosImg from \"../img/kerberos.jpg\"\r\n\r\nclass Kerberos extends React.Component {\r\n    render() {\r\n      return (\r\n        <div className=\"article\">\r\n          <h1>Kerberos</h1>\r\n          <hr/>\r\n          <p className=\"tabulation\">En mythologie, Kerberos (plus connu sous le nom de Cerbère) est un énorme chien à trois têtes qui garde l’entrée des Enfers. Dans le domaine informatique il s'agit du protocole d'authentification dans un réseau informatique qui a besoin de 3 entités distincte pour fonctionner, d'où la référence pour le nom.</p>\r\n\r\n          <img id=\"cerbere_img\" src={Cerbere} alt=\"schéma Kerberos\"/>\r\n\r\n          <h2>Qu'est-ce que Kerberos ?</h2>\r\n          <p className=\"tabulation\">Protocole d'authentification des utilisateurs dans un réseau développé par le MIT, fonctionnant de pair avec un Active Directory, il permet l'accès des utilisateurs à des services de manière authentifiée.</p>\r\n\r\n          <p>Le principe de Kerberos est de centraliser la gestion de l'authentification, de sorte que les identifiants n'aient pas besoin de circuler sur le réseau et les serveurs d'en avoir connaissance. Toute l'authentification est gérée par le <strong>KDC (Key Distribution Center)</strong> suivant 3 étapes :</p>\r\n          <ol>\r\n            <li><strong>Authentification</strong> du client auprès du KDC Authentication Service (AS)</li>\r\n            <li>Demande du client d'un <strong>Ticket de Service</strong> (TGS)</li>\r\n            <li><strong>Accès au service</strong> en lui fournissant le ticket associé</li>\r\n          </ol>  \r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Principe de fonctionnement</h2>\r\n\r\n          <img id=\"principe_kerberos\" src={KerberosImg} alt=\"schéma Kerberos\"/>\r\n\r\n          <ol>\r\n            <li>1.Le client demande à s'authentifier auprès du Serveur d'Authentification (AS) en demandant un TGT</li>\r\n            <li>2.Le KDC vérifie les données d’identification et renvoie en cas de succès au client un TGT</li>\r\n\r\n            <li>3. Le client envoie son TGT au TGS avec le Service Principal Name (SPN) de la ressource à laquelle il souhaite accéder</li>\r\n\r\n            <li>4.Le KDC vérifie le TGT et s’assure que l’utilisateur a droit d'accèder au service demandé</li>\r\n\r\n            <li>5.S'il y est autorisé, le TGS va alors fournir un ticket de service au client</li>\r\n\r\n            <li>6.Le client présente son ticket au service concerné, qui lui accordera l'accès au ressource selon ses privilèges</li>\r\n          </ol>\r\n\r\n          <p>Dans un environnement Active Directory, les contrôleurs de domaine (Domain controllers ou DC) jouent le rôle de KDC et assurent donc les services d'Authentication Server (AS) et de Ticket Granting Service (TGS)</p>\r\n\r\n\r\n          <p>[Comparaison foireuse] En gros on pourrait comparer le principe de ticketing de Kerberos à celui de certains parcs d'attraction : il faut d'abord un ticket d'entrée général pour accèder au parc (TGT) avant de faire la demande de tickets spécifiques pour accèder à chacune des attractions (TGS). A la différence que dans Kerberos il n'y a ni coupe-file ni fast-pass ;)</p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Quelle différence entre Kerberos et NTLM ?</h2>\r\n\r\n          [Définir NTLM]\r\n\r\n          <p className=\"tabulation\">La principale différence entre les deux systèmes est la vérification tierce partie et le chiffrement plus efficace de Kerberos. Cette étape supplémentaire du processus apporte une couche supplémentaire de sécurité importante par rapport à NTLM.\r\n\r\n          Actuellement, la technologie NTLM est obsolète et n'assure plus correctement la protection des données sensibles.</p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Les attaques sur Kerberos</h2>\r\n          <p>Kerberos étant la solution la plus déployée pour tout ce qui concerne l'authentification dans un réseau d'entreprise il est évidemment cibles de nombreuses attaques qui peuvent en cas de réussite mener jusqu'à la compromission totale du SI. </p>\r\n          <ul>\r\n            <li><a href=\"#spn\">Scan des SPN</a></li>\r\n            <li>Pass-the-ticket : falsification d'une clé de session pour la présenter à une ressource sous la forme de données d’identification</li>\r\n            <li><a href=\"#kerberoasting\">Kerberoasting</a></li>\r\n            <li><a href=\"#asreproasting\">AS-REPRoasting</a></li>\r\n            <li><a href=\"#golden\">Golden Ticket</a> : falsification d'un ticket accordant à un utilisateur un accès administrateur du domaine</li>\r\n            <li><a href=\"#silver\">Silver Ticket</a> : falsification d'un ticket donnant accès à un service</li>\r\n            <li>Credential stuffing (bruteforce) : tentatives répétées automatisées visant à cracker un mot de passe</li>\r\n            <li>Affaiblissement du chiffrement via un Skeleton Key : malware capable de passer outre Kerberos (nécessitant un accès admin)\r\n            </li>\r\n            <li>Attaque DCShadow : nouvelle attaque consistant à définir son propre contrôleur de domaine afin de s’infiltrer plus en profondeur</li>\r\n          </ul>\r\n          \r\n\r\n          <br/>\r\n          <hr id=\"spn\"/>\r\n          <br/>\r\n\r\n          <h3>Scan des Service Principal Name (SPN)</h3>\r\n\r\n          <p className=\"tabulation\">Afin de gagner en furtivité dans un réseau en environnement AD, le traditionnel scan de ports est à remplacer par un scan SPN. Il s'agit des chaînes de caractères associées à un service qui sont répertoriées pour chaque compte dans l'annuaire LDAP. <br/><br/> En faisant une requête LDAP sur le DC on peut donc énumérer l'ensemble des services. L'avantage étant qu'il n'y a pas besoin d'initier une connexion sur chacun des serveurs hébergeant un service. Cette méthode, plus discrète, peut être réaliser sur n'importe quel poste connecté à l'AD via la commande : <strong>setspn.exe</strong></p>\r\n\r\n          <br/>\r\n          <hr id=\"kerberoasting\"/>\r\n          <br/>\r\n\r\n          <h3>Kerberoasting</h3>\r\n          <p className=\"tabulation\">C'est une attaque qui cible les comptes de services qui sont répertoriés au niveau de l'annuaire LDAP (SPN). <br/> Le Kerberoasting consiste à demander au TGS des tickets de services pour chacun des SPN énumérés (récupérés auparavant via Setspn.exe par exemple), cela nécessite évidemment d'avoir un TGT donc au moins un compte user simple. <br/> Comme chaque ticket de service est chiffré avec une clé correspondant au hash du mot de passe il est ensuite possible de lancer une attaque par bruteforce pour casser le mot de passe du compte ciblé. \r\n          <br/><br/> \r\n          Le script GetUsersSPNs.py d'Impacket permet d'obtenir les hash des mots de passe des comptes de services à distance en fournissant l'adresse IP du DC et des creds d'un compte user simple.</p>\r\n\r\n          <br/>\r\n          <hr id=\"asreproasting\"/>\r\n          <br/>\r\n\r\n          <h3>AS-REPRoasting</h3>\r\n\r\n          <p className=\"tabulation\">Il existe une pré-authentification sur Kerberos qui consiste à ajouter à la 1ere requete la valeur de l'horodataga chiffrée avec la clé du compte utilisateur.<br/>\r\n          Si elle n'est pas présente càd si le flag \"DONT_REQ-AUTH\" est présent dans le champ UserAccountControl d'un compte utilisateur, alors  cela signifie que ce dernier peut faire une demande de TGT sans s'être pré-authentifié. <br/><br/>\r\n\r\n          L'AS-REPRoasting consiste à énumérer l'ensemble des comptes possèdant ce flag, de faire une demande de TGT à la place de ces utiisateurs pour tenter, en \"offline\", de casser leur mot de passe.<br/><br/>\r\n\r\n          <strong>GetNPUsers.py</strong> d'Impacket permet de récupérer les hash de ces comptes.\r\n          [screen]</p>\r\n\r\n          <br/>\r\n          <hr id=\"delegation\"/>\r\n          <br/>\r\n\r\n          <h3>Delegation d'authentification (sans contrainte)</h3>\r\n\r\n          <p className=\"tabulation\">Certains serveurs qui possèdent le flag \"TRUSTED_FOR_DELEGATION\" gardent en cache  dans le processus lsass les TGT des utilisateurs pour pouvoir effectuer à leur place la demande d'accès à un autre service. Ainsi en cas de compromission de l'un de ces serveurs on peut récupérer l'ensemble des TGT stockés. <br/><br/>\r\n\r\n          L'outil <strong>ldapdomaindump</strong> permet d'énumérer ces machines. \r\n          [screen]\r\n\r\n          <br/><br/>\r\n\r\n          On utilise ensuite Mimikatz pour récupérer les tickets en mémoire. <br/>\r\n          kerberos::list /export\r\n          [screen]\r\n          </p>\r\n\r\n          <br/>\r\n          <hr id=\"passtheticket\"/>\r\n          <br/>\r\n\r\n          <h3>Pass-The-Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Cette attaque consiste à injecter des TGT précedemment récupérés directement dans la mémoire du processus lsass d'autres machines pour augmenter ses accès.</p>\r\n\r\n          <br/>\r\n          <hr id=\"golden\"/>\r\n          <br/>\r\n\r\n          <h3>Golden Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Dans un environnement Active Directory, les comptes sont identifiés par un nom d’utilisateur et un mot de passe, l’utilisateur identifié obtient alors un ticket Kerberos contenant son jeton d’authentification.<br/><br/>\r\n\r\n          Le Golden Ticket est le jeton d’authentification associé au compte KRBTG, un compte spécial servant à chiffrer tous les jetons d’authentification du DC. Ce Golden Ticket peut être utiliser avec une technique de <strong>Pass-the-hash</strong> pour se connecter à n’importe quel compte.\r\n          </p>\r\n\r\n          <ol>\r\n            <li>Infecter une machine cible avec un malware qui permet un premier accès avec un compte utilisateur pour accéder à d’autres ressources réseau (souvent à partir d’un e-mail de phishing)</li>\r\n            <li>Augmenter suffisamment ses privilèges pour avoir accès au Contrôleur de domaine (DC)</li>\r\n            <li>Se connecter au DC et dumper le hash du mot de passe du compte KRBTG pour créer un Golden Ticket. (via mimikatz)</li>\r\n            <li>Le Golden Ticket permet d'accéder à toutes les ressources présentes sur le réseau</li>\r\n          </ol>\r\n\r\n          <p>Même une modification du mot de passe du compte KRBTG n'entraîne pas l'invalidation du jeton d’authentification, donc le Golden Ticket est immuable.</p>\r\n\r\n          <br/>\r\n          <hr id=\"silver\"/>\r\n          <br/>\r\n\r\n          <h3>Silver Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Avec le mot de passe d’un compte il est possible de l’utiliser pour créer un faux ticket d’authentification de service appelé <strong>Silver Ticker</strong>. La création de Silver Ticket est possible car Kerberos permet aux services de se connecter sans que la validité de leur jeton ne soit vérifiée.<br/><br/>\r\n\r\n          [Sean Metcalf] <br/><br/>\r\n          \r\n          Un Silver Ticket est un faux ticket d’authentification utilisé pour se connecter à certains comptes. Ils sont plus difficiles à détecter que les Golden Tickets en raison de l’absence de communication entre le service et le DC et comme la journalisation se fait en local sur l’ordinateur cible.<br/><br/>\r\n\r\n          Les tickets Kerberos sont vérifiés par le Certificat de compte habilité (PAC) mais les comptes de services (comme CIFS ou le pare-feu Windows) ne sont pas toujours vérifiés.<br/><br/>\r\n\r\n          Avec un Silver Ticket, on peut s'authentifier auprès du contrôleur de domaine ou utiliser une technique Pass-the-ticket pour augmenter ses accès. \r\n          </p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h3>Contre-mesures</h3>\r\n\r\n          <ul>\r\n            <li>mots de passe robustes pour les comptes de service</li>\r\n            <li>flag \"Not_DELEGATED\" sur l'attribut UserAccountControol des comptes d'utilisateurs ayant accès à des ressources sensibles.</li>\r\n            <li>changement du mot de passe du compte krbtgt 2 fois tous les 40 jours</li>\r\n            <li>détection d'un nombre trop important de demandes de ticket de service (Kerberoasting)</li>\r\n          </ul>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n          \r\n          <h3>Conclusion</h3>\r\n\r\n          <p className=\"tabulation\">Kerberos est un protocole d'authentification robuste et efficace qui est encore loin d’être obsolète.</p>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  export default Kerberos;  "]},"metadata":{},"sourceType":"module"}