{"ast":null,"code":"import _classCallCheck from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/mnt/c/Users/Nico/hackingfornoobs_frontend/node_modules/@babel/runtime/helpers/esm/inherits\";import React from'react';import Cerbere from\"../img/kerberos.png\";import KerberosImg from\"../img/kerberos.jpg\";import GoldenTicket from\"../img/golden_ticket.jpg\";import SilverTicket from\"../img/silver_ticket.jpg\";var Kerberos=/*#__PURE__*/function(_React$Component){_inherits(Kerberos,_React$Component);function Kerberos(){_classCallCheck(this,Kerberos);return _possibleConstructorReturn(this,_getPrototypeOf(Kerberos).apply(this,arguments));}_createClass(Kerberos,[{key:\"render\",value:function render(){return React.createElement(\"div\",{className:\"article\"},React.createElement(\"h1\",null,\"Kerberos\"),React.createElement(\"hr\",null),React.createElement(\"p\",{className:\"tabulation\"},\"En mythologie, Kerberos (plus connu sous le nom de Cerb\\xE8re) est un \\xE9norme chien \\xE0 trois t\\xEAtes qui garde l\\u2019entr\\xE9e des Enfers. Dans le domaine informatique il s'agit du protocole d'authentification dans un r\\xE9seau informatique qui a besoin de 3 entit\\xE9s distinctes pour fonctionner, d'o\\xF9 la r\\xE9f\\xE9rence pour le nom.\"),React.createElement(\"img\",{id:\"cerbere_img\",src:Cerbere,alt:\"sch\\xE9ma Kerberos\"}),React.createElement(\"h2\",null,\"Qu'est-ce que Kerberos ?\"),React.createElement(\"p\",{className:\"tabulation\"},\"Protocole d'authentification des utilisateurs dans un r\\xE9seau d\\xE9velopp\\xE9 par le \",React.createElement(\"strong\",null,\"MIT\"),\", fonctionnant de pair avec un Active Directory, il permet l'acc\\xE8s des utilisateurs \\xE0 des services de mani\\xE8re authentifi\\xE9e.\"),React.createElement(\"p\",null,\"Le principe de Kerberos est de centraliser la gestion de l'authentification, les identifiants n'ont plus besoin de circuler sur le r\\xE9seau et les serveurs d'en avoir connaissance. Toute l'authentification est g\\xE9r\\xE9e par le \",React.createElement(\"strong\",null,\"KDC (Key Distribution Center)\"),\".\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Principe de fonctionnement\"),React.createElement(\"img\",{id:\"principe_kerberos\",src:KerberosImg,alt:\"sch\\xE9ma Kerberos\"}),React.createElement(\"ol\",null,React.createElement(\"li\",null,\"Le client demande \\xE0 s'authentifier aupr\\xE8s du Serveur d'Authentification (\",React.createElement(\"strong\",null,\"AS\"),\") en demandant un \",React.createElement(\"strong\",null,\"TGT\")),React.createElement(\"li\",null,\"Le KDC v\\xE9rifie les donn\\xE9es d\\u2019identification et renvoie en cas de succ\\xE8s au client un TGT\"),React.createElement(\"li\",null,\"Le client envoie son TGT au \",React.createElement(\"strong\",null,\"TGS\"),\" avec le Service Principal Name (SPN) de la ressource \\xE0 laquelle il souhaite acc\\xE9der\"),React.createElement(\"li\",null,\"Le KDC v\\xE9rifie le TGT et s\\u2019assure que l\\u2019utilisateur a droit d'acc\\xE8der au service demand\\xE9\"),React.createElement(\"li\",null,\"S'il y est autoris\\xE9, le TGS va alors fournir un \",React.createElement(\"strong\",null,\"ticket de service\"),\" au client\"),React.createElement(\"li\",null,\"Le client pr\\xE9sente son ticket au service concern\\xE9, qui lui accordera l'acc\\xE8s aux ressources selon ses privil\\xE8ges\")),React.createElement(\"p\",null,\"Dans un environnement Active Directory, les contr\\xF4leurs de domaine (\",React.createElement(\"strong\",null,\"Domain controllers\"),\" ou DC) jouent le r\\xF4le de KDC et assurent donc les services d'\",React.createElement(\"strong\",null,\"Authentication Server\"),\" (AS) et de \",React.createElement(\"strong\",null,\"Ticket Granting Service\"),\" (TGS)\"),React.createElement(\"p\",null,React.createElement(\"strong\",null,\"[Comparaison foireuse]\"),\" \",React.createElement(\"br\",null),\"On pourrait comparer le principe de ticketing de Kerberos \\xE0 celui de certains parcs d'attraction : il faut d'abord un ticket d'entr\\xE9e g\\xE9n\\xE9ral pour acc\\xE8der au parc (TGT) avant de faire la demande de tickets sp\\xE9cifiques pour acc\\xE8der \\xE0 chacune des attractions (TGS). Dans Kerberos toutefois il n'y a ni coupe-file ni fast-pass ;)\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Quelle diff\\xE9rence entre Kerberos et NTLM ?\"),\"[Voir section \",React.createElement(\"strong\",null,\"Protocole NTLM\"),\"]\",React.createElement(\"p\",{className:\"tabulation\"},\"La principale diff\\xE9rence est la v\\xE9rification tierce partie et le chiffrement plus efficace de Kerberos. Cette \\xE9tape suppl\\xE9mentaire du processus apporte une couche suppl\\xE9mentaire de s\\xE9curit\\xE9 importante par rapport \\xE0 NTLM.\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h2\",null,\"Les attaques sur Kerberos\"),React.createElement(\"p\",{className:\"tabulation\"},\"Kerberos \\xE9tant la solution la plus d\\xE9ploy\\xE9e pour l'authentification dans un r\\xE9seau d'entreprise il est \\xE9videmment cible de nombreuses attaques qui peuvent mener jusqu'\\xE0 la compromission totale du SI. \"),React.createElement(\"ul\",null,React.createElement(\"li\",null,React.createElement(\"strong\",null,React.createElement(\"a\",{href:\"#spn\"},\"Scan des SPN\"))),React.createElement(\"li\",null,React.createElement(\"strong\",null,\"Pass-The-Ticket\")),React.createElement(\"li\",null,React.createElement(\"strong\",null,React.createElement(\"a\",{href:\"#kerberoasting\"},\"Kerberoasting\"))),React.createElement(\"li\",null,React.createElement(\"strong\",null,React.createElement(\"a\",{href:\"#asreproasting\"},\"AS-REPRoasting\"))),React.createElement(\"li\",null,React.createElement(\"strong\",null,React.createElement(\"a\",{href:\"#golden\"},\"Golden Ticket\"))),React.createElement(\"li\",null,React.createElement(\"strong\",null,React.createElement(\"a\",{href:\"#silver\"},\"Silver Ticket\"))),React.createElement(\"li\",null,React.createElement(\"strong\",null,\"Credential stuffing (Bruteforce)\")),React.createElement(\"li\",null,React.createElement(\"strong\",null,\"Affaiblissement du chiffrement (Skeleton Key)\")),React.createElement(\"li\",null,React.createElement(\"strong\",null,\"DCShadow\"))),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"spn\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Scan des Service Principal Name (SPN)\"),React.createElement(\"p\",{className:\"tabulation\"},\"Afin de gagner en furtivit\\xE9 dans un r\\xE9seau en environnement AD, le traditionnel scan de ports est \\xE0 remplacer par un \",React.createElement(\"strong\",null,\"scan SPN\"),\". Il s'agit des cha\\xEEnes de caract\\xE8res associ\\xE9es \\xE0 un service qui sont r\\xE9pertori\\xE9es pour chaque compte dans l'annuaire LDAP. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\" Une requ\\xEAte LDAP sur le DC permet donc d'\",React.createElement(\"strong\",null,\"\\xE9num\\xE9rer l'ensemble des services\"),\". L'avantage \\xE9tant qu'il n'y a pas besoin d'initier une connexion sur chacun des serveurs h\\xE9bergeant un service. Cette m\\xE9thode, plus discr\\xE8te, peut \\xEAtre r\\xE9aliser sur n'importe quel poste connect\\xE9 \\xE0 l'AD via la commande : \",React.createElement(\"strong\",null,\"setspn.exe\")),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"kerberoasting\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Kerberoasting\"),React.createElement(\"p\",{className:\"tabulation\"},\"L'attaque \",React.createElement(\"strong\",null,\"Kerberoasting\"),\" consiste \\xE0 demander au TGS des tickets de services pour chacun des SPN r\\xE9cup\\xE9r\\xE9s auparavant (via Setspn.exe par exemple), cela n\\xE9cessite \\xE9videmment d'avoir un TGT donc au moins un compte user simple. \",React.createElement(\"br\",null),\" Comme chaque ticket de service est chiffr\\xE9 avec une cl\\xE9 correspondant au hash du mot de passe il est ensuite possible de lancer une attaque \",React.createElement(\"strong\",null,\"bruteforce du mot de passe\"),\" pour le compte cibl\\xE9.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Le script \",React.createElement(\"strong\",null,\"GetUsersSPNs.py\"),\" d'Impacket permet d'obtenir les hash des mots de passe des comptes de services \\xE0 distance en fournissant l'adresse IP du DC et des creds d'un compte user simple.\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"asreproasting\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"AS-REPRoasting\"),React.createElement(\"p\",{className:\"tabulation\"},\"Il existe une pr\\xE9-authentification sur Kerberos qui consiste \\xE0 envoyer initialement la valeur de l'horodataga chiffr\\xE9e avec la cl\\xE9 du compte utilisateur.\",React.createElement(\"br\",null),\"Si elle n'est pas pr\\xE9sente c\\xE0d si le flag \",React.createElement(\"strong\",null,\"DONT_REQ-AUTH\"),\" est pr\\xE9sent dans le champ UserAccountControl d'un compte utilisateur, alors  cela signifie que ce dernier peut faire une demande de TGT sans s'\\xEAtre pr\\xE9-authentifi\\xE9. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\"L'\",React.createElement(\"strong\",null,\"AS-REPRoasting\"),\" consiste \\xE0 \\xE9num\\xE9rer l'ensemble des comptes avec ce flag, de faire une demande de TGT \\xE0 la place de ces utilisateurs pour tenter, en \\\"offline\\\", de \",React.createElement(\"strong\",null,\"casser leur mot de passe.\"),React.createElement(\"br\",null),React.createElement(\"br\",null),React.createElement(\"strong\",null,\"GetNPUsers.py\"),\" d'Impacket permet de r\\xE9cup\\xE9rer les hash de ces comptes. [screen]\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"delegation\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Delegation d'authentification (sans contrainte)\"),React.createElement(\"p\",{className:\"tabulation\"},\"Certains serveurs qui ont le flag \",React.createElement(\"strong\",null,\"TRUSTED_FOR_DELEGATION\"),\" gardent en cache  dans le processus lsass les TGT des utilisateurs pour pouvoir effectuer \\xE0 leur place la demande d'acc\\xE8s \\xE0 un autre service. Ainsi en cas de compromission d'un de ces serveurs on peut r\\xE9cup\\xE9rer l'ensemble des TGT stock\\xE9s. \",React.createElement(\"br\",null),React.createElement(\"br\",null),\"L'outil \",React.createElement(\"strong\",null,\"ldapdomaindump\"),\" permet d'\\xE9num\\xE9rer ces machines. \",React.createElement(\"br\",null),\"[add screenshot]\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"On utilise ensuite \",React.createElement(\"strong\",null,\"Mimikatz\"),\" pour r\\xE9cup\\xE9rer les tickets en m\\xE9moire. \"),React.createElement(\"p\",{id:\"terminal\"},\"kerberos::list /export>\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"passtheticket\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Pass-The-Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Cette attaque consiste \\xE0 injecter des TGT pr\\xE9cedemment r\\xE9cup\\xE9r\\xE9s directement dans la m\\xE9moire du processus lsass d'autres machines pour augmenter ses acc\\xE8s.\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"golden\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Golden Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Dans un environnement AD, les comptes sont identifi\\xE9s par un nom d\\u2019utilisateur et un mot de passe, l\\u2019utilisateur identifi\\xE9 obtient alors un ticket Kerberos contenant son jeton d\\u2019authentification.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Le Golden Ticket est le jeton d\\u2019authentification associ\\xE9 au compte KRBTG, un compte sp\\xE9cial servant \\xE0 chiffrer tous les jetons d\\u2019authentification du DC. Ce Golden Ticket peut \\xEAtre utiliser avec une technique de \",React.createElement(\"strong\",null,\"Pass-The-Hash\"),\" pour se connecter \\xE0 n\\u2019importe quel compte.\"),React.createElement(\"img\",{id:\"golden_ticket\",src:GoldenTicket,alt:\"golden ticket\"}),React.createElement(\"p\",null,\"La m\\xE9thodologie de compromission d'un AD est la suivante : \"),React.createElement(\"ol\",null,React.createElement(\"li\",null,\"Infecter une machine cible pour avoir un premier acc\\xE8s avec un compte utilisateur et acc\\xE9der \\xE0 d\\u2019autres ressources r\\xE9seau (e-mail de phishing)\"),React.createElement(\"li\",null,\"Augmenter suffisamment ses privil\\xE8ges pour avoir acc\\xE8s au Contr\\xF4leur de Domaine (DC)\"),React.createElement(\"li\",null,\"Se connecter au DC et dumper le hash du mot de passe du \",React.createElement(\"strong\",null,\"compte KRBTG\"),\" pour cr\\xE9er un Golden Ticket. (\",React.createElement(\"strong\",null,\"Mimikatz\"),\")\"),React.createElement(\"li\",null,\"Le Golden Ticket donne acc\\xE8s \\xE0 toutes les ressources pr\\xE9sentes sur le r\\xE9seau.\")),React.createElement(\"p\",null,\"M\\xEAme une modification du mot de passe du compte KRBTG n'entra\\xEEne pas l'invalidation du jeton d\\u2019authentification, donc le Golden Ticket est \",React.createElement(\"strong\",null,\"immuable\"),\".\"),React.createElement(\"br\",null),React.createElement(\"hr\",{id:\"silver\"}),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Silver Ticket\"),React.createElement(\"p\",{className:\"tabulation\"},\"Il est possible d\\u2019utiliser le mot de passe d'un compte pour cr\\xE9er un faux ticket d\\u2019authentification de service appel\\xE9 \",React.createElement(\"strong\",null,\"Silver Ticker\"),\". La cr\\xE9ation d'un Silver Ticket est possible car Kerberos permet aux services de se connecter sans que la validit\\xE9 de leur jeton ne soit v\\xE9rifi\\xE9e.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"[Sean Metcalf] \"),React.createElement(\"img\",{id:\"silver_ticket\",src:SilverTicket,alt:\"silver ticket\"}),React.createElement(\"p\",{className:\"tabulation\"},\"Ils sont plus difficiles \\xE0 d\\xE9tecter que les Golden Tickets en raison de l\\u2019absence de communication entre le service et le DC et vu que la journalisation se fait en local sur l\\u2019ordinateur cible.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Les tickets Kerberos sont g\\xE9n\\xE9ralement v\\xE9rifi\\xE9s par le Certificat de compte habilit\\xE9 (PAC) mais les comptes de services (comme CIFS ou le pare-feu Windows) ne le sont pas toujours.\",React.createElement(\"br\",null),React.createElement(\"br\",null),\"Avec un Silver Ticket, on peut s'authentifier aupr\\xE8s du Contr\\xF4leur de Domaine ou utiliser une technique \",React.createElement(\"strong\",null,\"Pass-The-Ticket\"),\" pour augmenter ses acc\\xE8s.\"),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Contre-mesures\"),React.createElement(\"ul\",null,React.createElement(\"li\",null,\"Mots de passe robustes pour les comptes de service\"),React.createElement(\"li\",null,\"Flag \\\"Not_DELEGATED\\\" sur l'attribut UserAccountControol des comptes d'utilisateurs ayant acc\\xE8s \\xE0 des ressources sensibles.\"),React.createElement(\"li\",null,\"Changer le mot de passe du compte krbtgt r\\xE9guli\\xE8rement\"),React.createElement(\"li\",null,\"D\\xE9tecter un nombre trop important de demandes de ticket de service (\",React.createElement(\"strong\",null,\"Kerberoasting\"),\")\")),React.createElement(\"br\",null),React.createElement(\"hr\",null),React.createElement(\"br\",null),React.createElement(\"h3\",null,\"Conclusion\"),React.createElement(\"p\",{className:\"tabulation\"},\"Malgr\\xE9 les attaques possibles, Kerberos est un protocole d'authentification robuste et efficace qui est encore loin d\\u2019\\xEAtre obsol\\xE8te.\"));}}]);return Kerberos;}(React.Component);export default Kerberos;","map":{"version":3,"sources":["/mnt/c/Users/Nico/hackingfornoobs_frontend/src/components/Kerberos.js"],"names":["React","Cerbere","KerberosImg","GoldenTicket","SilverTicket","Kerberos","Component"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport Cerbere from \"../img/kerberos.png\"\r\nimport KerberosImg from \"../img/kerberos.jpg\"\r\nimport GoldenTicket from \"../img/golden_ticket.jpg\"\r\nimport SilverTicket from \"../img/silver_ticket.jpg\"\r\n\r\nclass Kerberos extends React.Component {\r\n    render() {\r\n      return (\r\n        <div className=\"article\">\r\n          <h1>Kerberos</h1>\r\n          <hr/>\r\n          <p className=\"tabulation\">En mythologie, Kerberos (plus connu sous le nom de Cerbère) est un énorme chien à trois têtes qui garde l’entrée des Enfers. Dans le domaine informatique il s'agit du protocole d'authentification dans un réseau informatique qui a besoin de 3 entités distinctes pour fonctionner, d'où la référence pour le nom.</p>\r\n\r\n          <img id=\"cerbere_img\" src={Cerbere} alt=\"schéma Kerberos\"/>\r\n\r\n          <h2>Qu'est-ce que Kerberos ?</h2>\r\n          <p className=\"tabulation\">Protocole d'authentification des utilisateurs dans un réseau développé par le <strong>MIT</strong>, fonctionnant de pair avec un Active Directory, il permet l'accès des utilisateurs à des services de manière authentifiée.</p>\r\n\r\n          <p>Le principe de Kerberos est de centraliser la gestion de l'authentification, les identifiants n'ont plus besoin de circuler sur le réseau et les serveurs d'en avoir connaissance. Toute l'authentification est gérée par le <strong>KDC (Key Distribution Center)</strong>.</p> \r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Principe de fonctionnement</h2>\r\n\r\n          <img id=\"principe_kerberos\" src={KerberosImg} alt=\"schéma Kerberos\"/>\r\n\r\n          <ol>\r\n            <li>Le client demande à s'authentifier auprès du Serveur d'Authentification (<strong>AS</strong>) en demandant un <strong>TGT</strong></li>\r\n            <li>Le KDC vérifie les données d’identification et renvoie en cas de succès au client un TGT</li>\r\n\r\n            <li>Le client envoie son TGT au <strong>TGS</strong> avec le Service Principal Name (SPN) de la ressource à laquelle il souhaite accéder</li>\r\n\r\n            <li>Le KDC vérifie le TGT et s’assure que l’utilisateur a droit d'accèder au service demandé</li>\r\n\r\n            <li>S'il y est autorisé, le TGS va alors fournir un <strong>ticket de service</strong> au client</li>\r\n\r\n            <li>Le client présente son ticket au service concerné, qui lui accordera l'accès aux ressources selon ses privilèges</li>\r\n          </ol>\r\n\r\n          <p>Dans un environnement Active Directory, les contrôleurs de domaine (<strong>Domain controllers</strong> ou DC) jouent le rôle de KDC et assurent donc les services d'<strong>Authentication Server</strong> (AS) et de <strong>Ticket Granting Service</strong> (TGS)</p>\r\n\r\n\r\n          <p><strong>[Comparaison foireuse]</strong> <br/>On pourrait comparer le principe de ticketing de Kerberos à celui de certains parcs d'attraction : il faut d'abord un ticket d'entrée général pour accèder au parc (TGT) avant de faire la demande de tickets spécifiques pour accèder à chacune des attractions (TGS). Dans Kerberos toutefois il n'y a ni coupe-file ni fast-pass ;)</p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Quelle différence entre Kerberos et NTLM ?</h2>\r\n\r\n          [Voir section <strong>Protocole NTLM</strong>]\r\n\r\n          <p className=\"tabulation\">La principale différence est la vérification tierce partie et le chiffrement plus efficace de Kerberos. Cette étape supplémentaire du processus apporte une couche supplémentaire de sécurité importante par rapport à NTLM.</p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h2>Les attaques sur Kerberos</h2>\r\n          <p className=\"tabulation\">Kerberos étant la solution la plus déployée pour l'authentification dans un réseau d'entreprise il est évidemment cible de nombreuses attaques qui peuvent mener jusqu'à la compromission totale du SI. </p>\r\n          <ul>\r\n            <li><strong><a href=\"#spn\">Scan des SPN</a></strong></li>\r\n            <li><strong>Pass-The-Ticket</strong></li>\r\n            <li><strong><a href=\"#kerberoasting\">Kerberoasting</a></strong></li>\r\n            <li><strong><a href=\"#asreproasting\">AS-REPRoasting</a></strong></li>\r\n            <li><strong><a href=\"#golden\">Golden Ticket</a></strong></li>\r\n            <li><strong><a href=\"#silver\">Silver Ticket</a></strong></li>\r\n            <li><strong>Credential stuffing (Bruteforce)</strong></li>\r\n            <li><strong>Affaiblissement du chiffrement (Skeleton Key)</strong></li>\r\n            <li><strong>DCShadow</strong></li>\r\n          </ul>\r\n          \r\n\r\n          <br/>\r\n          <hr id=\"spn\"/>\r\n          <br/>\r\n\r\n          <h3>Scan des Service Principal Name (SPN)</h3>\r\n\r\n          <p className=\"tabulation\">Afin de gagner en furtivité dans un réseau en environnement AD, le traditionnel scan de ports est à remplacer par un <strong>scan SPN</strong>. Il s'agit des chaînes de caractères associées à un service qui sont répertoriées pour chaque compte dans l'annuaire LDAP. <br/><br/> Une requête LDAP sur le DC permet donc d'<strong>énumérer l'ensemble des services</strong>. L'avantage étant qu'il n'y a pas besoin d'initier une connexion sur chacun des serveurs hébergeant un service. Cette méthode, plus discrète, peut être réaliser sur n'importe quel poste connecté à l'AD via la commande : <strong>setspn.exe</strong></p>\r\n\r\n          <br/>\r\n          <hr id=\"kerberoasting\"/>\r\n          <br/>\r\n\r\n          <h3>Kerberoasting</h3>\r\n          <p className=\"tabulation\">L'attaque <strong>Kerberoasting</strong> consiste à demander au TGS des tickets de services pour chacun des SPN récupérés auparavant (via Setspn.exe par exemple), cela nécessite évidemment d'avoir un TGT donc au moins un compte user simple. <br/> Comme chaque ticket de service est chiffré avec une clé correspondant au hash du mot de passe il est ensuite possible de lancer une attaque <strong>bruteforce du mot de passe</strong> pour le compte ciblé. \r\n          <br/><br/> \r\n          Le script <strong>GetUsersSPNs.py</strong> d'Impacket permet d'obtenir les hash des mots de passe des comptes de services à distance en fournissant l'adresse IP du DC et des creds d'un compte user simple.</p>\r\n\r\n          <br/>\r\n          <hr id=\"asreproasting\"/>\r\n          <br/>\r\n\r\n          <h3>AS-REPRoasting</h3>\r\n\r\n          <p className=\"tabulation\">Il existe une pré-authentification sur Kerberos qui consiste à envoyer initialement la valeur de l'horodataga chiffrée avec la clé du compte utilisateur.<br/>\r\n          Si elle n'est pas présente càd si le flag <strong>DONT_REQ-AUTH</strong> est présent dans le champ UserAccountControl d'un compte utilisateur, alors  cela signifie que ce dernier peut faire une demande de TGT sans s'être pré-authentifié. <br/><br/>\r\n\r\n          L'<strong>AS-REPRoasting</strong> consiste à énumérer l'ensemble des comptes avec ce flag, de faire une demande de TGT à la place de ces utilisateurs pour tenter, en \"offline\", de <strong>casser leur mot de passe.</strong><br/><br/>\r\n\r\n          <strong>GetNPUsers.py</strong> d'Impacket permet de récupérer les hash de ces comptes.\r\n          [screen]</p>\r\n\r\n          <br/>\r\n          <hr id=\"delegation\"/>\r\n          <br/>\r\n\r\n          <h3>Delegation d'authentification (sans contrainte)</h3>\r\n\r\n          <p className=\"tabulation\">Certains serveurs qui ont le flag <strong>TRUSTED_FOR_DELEGATION</strong> gardent en cache  dans le processus lsass les TGT des utilisateurs pour pouvoir effectuer à leur place la demande d'accès à un autre service. Ainsi en cas de compromission d'un de ces serveurs on peut récupérer l'ensemble des TGT stockés. <br/><br/>\r\n\r\n          L'outil <strong>ldapdomaindump</strong> permet d'énumérer ces machines. <br/>\r\n          [add screenshot]\r\n\r\n          <br/><br/>\r\n\r\n          On utilise ensuite <strong>Mimikatz</strong> pour récupérer les tickets en mémoire. </p>\r\n\r\n          <p id=\"terminal\">kerberos::list /export></p>\r\n      \r\n\r\n          <br/>\r\n          <hr id=\"passtheticket\"/>\r\n          <br/>\r\n\r\n          <h3>Pass-The-Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Cette attaque consiste à injecter des TGT précedemment récupérés directement dans la mémoire du processus lsass d'autres machines pour augmenter ses accès.</p>\r\n\r\n          <br/>\r\n          <hr id=\"golden\"/>\r\n          <br/>\r\n\r\n          <h3>Golden Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Dans un environnement AD, les comptes sont identifiés par un nom d’utilisateur et un mot de passe, l’utilisateur identifié obtient alors un ticket Kerberos contenant son jeton d’authentification.<br/><br/>\r\n\r\n          Le Golden Ticket est le jeton d’authentification associé au compte KRBTG, un compte spécial servant à chiffrer tous les jetons d’authentification du DC. Ce Golden Ticket peut être utiliser avec une technique de <strong>Pass-The-Hash</strong> pour se connecter à n’importe quel compte.\r\n          </p>\r\n\r\n          <img id=\"golden_ticket\" src={GoldenTicket} alt=\"golden ticket\"/>\r\n\r\n          <p>La méthodologie de compromission d'un AD est la suivante : </p>\r\n          <ol>\r\n            <li>Infecter une machine cible pour avoir un premier accès avec un compte utilisateur et accéder à d’autres ressources réseau (e-mail de phishing)</li>\r\n            <li>Augmenter suffisamment ses privilèges pour avoir accès au Contrôleur de Domaine (DC)</li>\r\n            <li>Se connecter au DC et dumper le hash du mot de passe du <strong>compte KRBTG</strong> pour créer un Golden Ticket. (<strong>Mimikatz</strong>)</li>\r\n            <li>Le Golden Ticket donne accès à toutes les ressources présentes sur le réseau.</li>\r\n          </ol>\r\n\r\n          <p>Même une modification du mot de passe du compte KRBTG n'entraîne pas l'invalidation du jeton d’authentification, donc le Golden Ticket est <strong>immuable</strong>.</p>\r\n\r\n          <br/>\r\n          <hr id=\"silver\"/>\r\n          <br/>\r\n\r\n          <h3>Silver Ticket</h3>\r\n\r\n          <p className=\"tabulation\">Il est possible d’utiliser le mot de passe d'un compte pour créer un faux ticket d’authentification de service appelé <strong>Silver Ticker</strong>. La création d'un Silver Ticket est possible car Kerberos permet aux services de se connecter sans que la validité de leur jeton ne soit vérifiée.<br/><br/>\r\n\r\n          [Sean Metcalf] </p>\r\n\r\n          \r\n          <img id=\"silver_ticket\" src={SilverTicket} alt=\"silver ticket\"/>\r\n          \r\n          <p className=\"tabulation\">Ils sont plus difficiles à détecter que les Golden Tickets en raison de l’absence de communication entre le service et le DC et vu que la journalisation se fait en local sur l’ordinateur cible.<br/><br/>\r\n\r\n          Les tickets Kerberos sont généralement vérifiés par le Certificat de compte habilité (PAC) mais les comptes de services (comme CIFS ou le pare-feu Windows) ne le sont pas toujours.<br/><br/>\r\n\r\n          Avec un Silver Ticket, on peut s'authentifier auprès du Contrôleur de Domaine ou utiliser une technique <strong>Pass-The-Ticket</strong> pour augmenter ses accès. \r\n          </p>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n\r\n          <h3>Contre-mesures</h3>\r\n\r\n          <ul>\r\n            <li>Mots de passe robustes pour les comptes de service</li>\r\n            <li>Flag \"Not_DELEGATED\" sur l'attribut UserAccountControol des comptes d'utilisateurs ayant accès à des ressources sensibles.</li>\r\n            <li>Changer le mot de passe du compte krbtgt régulièrement</li>\r\n            <li>Détecter un nombre trop important de demandes de ticket de service (<strong>Kerberoasting</strong>)</li>\r\n          </ul>\r\n\r\n          <br/>\r\n          <hr/>\r\n          <br/>\r\n          \r\n          <h3>Conclusion</h3>\r\n\r\n          <p className=\"tabulation\">Malgré les attaques possibles, Kerberos est un protocole d'authentification robuste et efficace qui est encore loin d’être obsolète.</p>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  export default Kerberos;  "]},"metadata":{},"sourceType":"module"}